<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><script type="text/javascript" src="//use.typekit.net/msd6bqv.js"></script><script type="text/javascript">try{Typekit.load();}catch(e){}</script><title data-react-helmet="true">Revertible Observables in Knockout | benmccormick.org</title><style>.header-link{color:hsla(0,0%,39%,.7)}.header-link:hover{color:#e2777a}.markdown pre{display:block;background:#fdf6e3;color:#657b83;overflow-y:hidden;padding:.2rem .5rem}.markdown pre code{background:none;border:none;border-radius:3px;display:inline-block;overflow:inherit;padding:0;white-space:inherit;word-wrap:normal;font-size:.7rem;line-height:1rem}code{border-radius:3px;white-space:pre;white-space:pre-wrap;white-space:pre-line;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:-moz-pre-wrap;white-space:-hp-pre-wrap;word-wrap:break-word;border:1px solid #ccc;display:inline;font-family:Inconsolata,monospace,serif;max-width:100%;overflow:auto;padding:0 .1625rem}.hljs,code{background:#fdf6e3;color:#657b83}.hljs{display:block;overflow-x:auto;padding:.5em}.hljs-comment,.hljs-quote{color:#93a1a1}.hljs-addition,.hljs-keyword,.hljs-selector-tag{color:#859900}.hljs-doctag,.hljs-literal,.hljs-meta .hljs-meta-string,.hljs-number,.hljs-regexp,.hljs-string{color:#2aa198}.hljs-name,.hljs-section,.hljs-selector-class,.hljs-selector-id,.hljs-title{color:#268bd2}.hljs-attr,.hljs-attribute,.hljs-class .hljs-title,.hljs-template-variable,.hljs-type,.hljs-variable{color:#b58900}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-meta .hljs-keyword,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol{color:#cb4b16}.hljs-built_in,.hljs-deletion{color:#dc322f}.hljs-formula{background:#eee8d5}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}body,h1,h2,h3,h4,h5,h6,p{font-family:brandon-grotesque,Brandon Grotesque,Helvetica Neue,Helvetica,Arial,Lucida Sans,Geneva,Verdana,sans-serif;text-rendering:optimizeLegibility}a{color:#e2777a;text-decoration:none}blockquote{border-left:5px solid #57a3e8;font-style:italic;background:#eee;font-weight:400;font-size:.9rem;padding:10px 20px;margin:0 0 30px -25px}h2,h3{color:#57a3e8}.explanation{padding:10px;background:#eee;border-radius:10px;margin:20px auto;font-size:.85em}.reading-img img{width:150px;float:right;margin:10px}</style></head><body class="landing-page" style="background:#FCFCFC;"><div id="react-mount"><div style="max-width:39.984rem;margin-left:auto;margin-right:auto;padding:2.499rem 1.2495rem;" data-reactroot="" data-reactid="1" data-react-checksum="-980461371"><div style="display:flex;padding-bottom:0.5rem;margin-bottom:0.5rem;" data-reactid="2"><div style="flex-grow:3;display:flex;flex-direction:column;justify-content:space-around;" data-reactid="3"><h3 style="margin:0;padding-bottom:0;" data-reactid="4"><a style="box-shadow:none;text-decoration:none;color:inherit;" href="/benmccormickorg/" data-reactid="5">benmccormick.org</a></h3><div style="color:rgba(100,100,100, 0.7);" data-reactid="6"><a class="header-link" href="/benmccormickorg/subscribe/" data-reactid="7">Subscribe</a><span style="padding:0 0.33rem;" data-reactid="8">•</span><a class="header-link" href="/benmccormickorg/readinglist/" data-reactid="9">Reading List</a><span style="padding:0 0.33rem;" data-reactid="10">•</span><a class="header-link" href="http://twitter.com/ben336" data-reactid="11">Twitter</a><span style="padding:0 0.33rem;" data-reactid="12">•</span><a class="header-link" href="/benmccormickorg/about/" data-reactid="13">About</a></div></div><div style="flex-shrink:2;" data-reactid="14"><div data-reactid="15"><a href="https://www.amazon.com/Effective-JavaScript-Specific-Software-Development/dp/0321812182/ref=as_li_ss_il?ie=UTF8&amp;linkCode=li1&amp;tag=benmccormicko-20&amp;linkId=204d9fef609d10bc79cb424fc44fd1ab" target="_blank" data-reactid="16"><div style="max-height:6.5rem;display:flex;justify-content:flex-end;background:#F0F0F0;padding:0.2rem;" data-reactid="17"><div data-reactid="18"><img src="//ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=0321812182&amp;Format=_SL110_&amp;ID=AsinImage&amp;MarketPlace=US&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=benmccormicko-20" data-reactid="19"/><img src="https://ir-na.amazon-adsystem.com/e/ir?t=benmccormicko-20&amp;l=li1&amp;o=1&amp;a=0321812182" width="1" height="1" alt="" style="border:none;margin:0px;" data-reactid="20"/></div><div style="font-size:0.6em;line-height:1em;max-width:5rem;padding:0 0.5rem;display:flex;align-items:center;flex-direction:column;justify-content:space-between;color:rgba(100, 100, 100, 0.701961);" data-reactid="21"><span data-reactid="22">Please support this blog by shopping on Amazon</span><a href="/benmccormickorg/amazonlinks" data-reactid="23">What is this?</a></div></div></a></div></div></div><div class="markdown" data-reactid="24"><!-- react-empty: 25 --><h5 style="display:block;color:rgba(100,100,100, 0.7);margin-bottom:0.4165rem;" data-reactid="26">May 7, 2013</h5><h1 style="margin-top:0;margin-bottom:1rem;" data-reactid="27">Revertible Observables in Knockout</h1><div class="article-body" data-reactid="28"><p>Last week I was looking for a way to use KnockoutJS on a configuration menu that required the user to be able to cancel or accept their input after filling out the menu.</p>
<p>Initially I was just copying the initial data and refilling my data model manually on cancel.  I wasn’t satisfied with that solution though.  It didn’t seem like it would scale well if the menu got more complicated, and it lacked the elegance and frictionless nature of most knockout data management.</p>
<p>After some searching I found <a href="http://www.knockmeout.net/2011/03/guard-your-model-accept-or-cancel-edits.html">Ryan Niemeyer’s Protected Observable example</a>, and it initially seemed like exactly what I wanted, a way to only persist changes to the view model if they were explicitly confirmed.</p>
<pre><code class="language-javascript"><span class="hljs-comment">//knockout-protected.js</span>
<span class="hljs-comment">//https://gist.github.com/ben336/5537138#file-knockout-protected-js</span>

<span class="hljs-comment">//wrapper to an observable that requires accept/cancel</span>
ko.protectedObservable = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">initialValue</span>) </span>{
    <span class="hljs-comment">//private variables</span>
    <span class="hljs-keyword">var</span> _actualValue = ko.observable(initialValue),
        _tempValue = initialValue;

    <span class="hljs-comment">//computed observable that we will return</span>
    <span class="hljs-keyword">var</span> result = ko.computed({
        <span class="hljs-comment">//always return the actual value</span>
        read: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
           <span class="hljs-keyword">return</span> _actualValue();
        },
        <span class="hljs-comment">//stored in a temporary spot until commit</span>
        write: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>) </span>{
             _tempValue = newValue;
        }
    });

    <span class="hljs-comment">//if different, commit temp value</span>
    result.commit = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (_tempValue !== _actualValue()) {
             _actualValue(_tempValue);
        }
    };

    <span class="hljs-comment">//force subscribers to take original</span>
    result.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        _actualValue.valueHasMutated();
        _tempValue = _actualValue();   <span class="hljs-comment">//reset temp value</span>
    };

    <span class="hljs-keyword">return</span> result;
};

</code></pre>
<p>There was a problem with this approach though.  Ryan’s model saves the update to a temporary value and then moves it into an observable if the result is committed.  That works great for simple models and mostly behaves well if the user cancels out of the edit screen without committing or resetting. But it breaks down if you have another computed observable that depends on the value of the protected observable.  In my case I had an output that I wanted to show dynamically changing based on the input allowing experimentation.  Here’s a simplified example using a protected observable:</p>
<iframe width="100%" height="300" src="http://jsfiddle.net/tc299/4/embedded/" allowfullscreen="allowfullscreen" frameborder="0"></iframe>
<p>As you can see, the tables field doesn’t update until you confirm the entry. Ideally though we’d like it to update as the user changes their guest number, so they can see the effect on cost and space used before they confirm a change in guests.  We want to do this while still preserving the users abilities to cancel changes if they don’t like the results though.  So how to we do this?  We make a small change to the default value returned by the protected observable.  Here’s what I’m calling a Revertible Observable:</p>
<pre><code class="language-javascript"><span class="hljs-comment">/*
knockout-revertible.js
https://gist.github.com/ben336/5537115#file-knockout-revertible-js
*/</span>

 <span class="hljs-comment">//wrapper to an observable that requires accept/cancel</span>
ko.revertibleObservable = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">initialValue</span>) </span>{
    <span class="hljs-comment">//private variables</span>
    <span class="hljs-keyword">var</span> _actualValue = initialValue,
        _tempValue = ko.observable(initialValue);

    <span class="hljs-comment">//computed observable that we will return</span>
    <span class="hljs-keyword">var</span> result = ko.computed({
        <span class="hljs-comment">//always return the current value</span>
        read: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
           <span class="hljs-keyword">return</span> _tempValue();
        },
        <span class="hljs-comment">//stored in a temporary spot until commit</span>
        write: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>) </span>{
             _tempValue(newValue);
        }
    });

    <span class="hljs-comment">//if different, commit temp value</span>
    result.commit = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (_tempValue() !== _actualValue) {
            _tempValue.valueHasMutated();
             _actualValue = _tempValue();
        }
    };

    <span class="hljs-comment">//force subscribers to take original</span>
    result.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        _tempValue(_actualValue);   <span class="hljs-comment">//reset temp value</span>
    };

    <span class="hljs-keyword">return</span> result;
};

</code></pre>
<p>This preserves the ability to see the results of your changes in realtime, while also allowing you to easily revert with a simple cancel button and no explicit data tracking.  Now our example can work as we’d like, with the customer getting immediate feedback on how their guest changes effect the total cost.</p>
<iframe width="100%" height="300" src="http://jsfiddle.net/QQYrL/4/embedded/" allowfullscreen="allowfullscreen" frameborder="0"></iframe>
<p>Note that this isn’t a silver bullet.  An explicit confirmation is no longer required for the changes to be passed through, so its important to make sure that the user either confirms or resets the values after entering them.  But it allows for instant feedback on changes while still supporting the ability to dump the changes if the user decides they don’t like the result.  I think its a useful pattern for any situation where the user is entering data and you want to show them a preview of the outcome.  I hope others will find it as useful as I have.</p>
<h3>Update</h3>
<p>I showed this to Ryan and he replied with a nice simplification of the concept.</p>
<blockquote class="twitter-tweet"><p>@<a href="https://twitter.com/ben336">ben336</a> nice Ben. I have had to do something similar in the past. Here is a simplified version that I have used: <a href="http://t.co/IiqFe90kwi" title="http://jsfiddle.net/rniemeyer/SFCgr/">jsfiddle.net/rniemeyer/SFCg…</a></p>&mdash; Ryan Niemeyer (@RPNiemeyer) <a href="https://twitter.com/RPNiemeyer/status/331954950009663488">May 8, 2013</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
<pre><code class="language-javascript"><span class="hljs-comment">//Ryan Niemeyer's simplified knockout-revertible.js</span>
<span class="hljs-comment">//http://jsfiddle.net/rniemeyer/SFCgr/ Fiddle</span>
 ko.revertibleObservable = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">initialValue</span>) </span>{
    <span class="hljs-comment">//private variables</span>
    <span class="hljs-keyword">var</span> result = ko.observable(initialValue);

    result.forEditing = ko.observable(initialValue);

    <span class="hljs-comment">//if different, commit edit value</span>
    result.commit = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> editValue = result.forEditing();

        <span class="hljs-keyword">if</span> (editValue !== result()) {
            result(editValue);
        }
    };

    <span class="hljs-comment">//force subscribers to take original</span>
    result.reset = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        result.forEditing(result());
    };

    <span class="hljs-keyword">return</span> result;
};

</code></pre>
</div><hr style="margin-bottom:3.332rem;" data-reactid="29"/><noscript data-reactid="30"></noscript><p style="margin-bottom:4.165rem;" data-reactid="31"><!-- react-text: 32 -->Written by <!-- /react-text --><!-- react-text: 33 -->Ben McCormick<!-- /react-text --></p></div><span style="display:block;clear:both;" data-reactid="34"> </span></div></div><script src="/benmccormickorg/bundle.js?t=1474678920818"></script></body></html>